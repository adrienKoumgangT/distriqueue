# ============================================
# RabbitMQ Configuration for DistriQueue
# ============================================

# ============================================
# Network & Listeners
# ============================================

# AMQP listener
listeners.tcp.default = 5672

# Management UI
management.tcp.port = 15672
management.tcp.ip   = 0.0.0.0

# Prometheus metrics
prometheus.tcp.port = 15692
prometheus.tcp.ip   = 0.0.0.0
prometheus.return_per_object_metrics = true

# ============================================
# Clustering Configuration
# ============================================

# Cluster name
cluster.name = distriqueue-cluster

# Node type (disc = persistent, ram = in-memory)
# Use disc for at least one node in the cluster
cluster.node_type = disc

# Cluster formation
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
cluster_formation.classic_config.nodes.1 = rabbit@rabbitmq1
cluster_formation.classic_config.nodes.2 = rabbit@rabbitmq2
cluster_formation.classic_config.nodes.3 = rabbit@rabbitmq3

# Partition handling strategy
# Available: ignore, pause_minority, pause_if_all_down, autoheal
cluster_partition_handling = autoheal

# Keepalive interval in milliseconds
cluster_keepalive_interval = 10000

# ============================================
# Memory & Disk Management
# ============================================

# Memory high watermark - when RabbitMQ will start flow control
# Relative value (fraction of available RAM)
vm_memory_high_watermark.relative = 0.8

# Absolute memory limit (uncomment to set fixed limit)
# vm_memory_high_watermark.absolute = 2GB

# Memory monitoring interval
vm_memory_calculation_strategy = rss

# Disk free space limit
# Relative to total disk space
disk_free_limit.relative = 2.0

# Absolute disk free limit (uncomment to set fixed limit)
# disk_free_limit.absolute = 2GB

# ============================================
# Queue & Message Configuration
# ============================================

# Default queue type (classic, quorum, stream)
default_queue_type = classic

# Queue master locator strategy
# Available: min-masters, client-local, random
queue_master_locator = min-masters

# Maximum queue length (0 = unlimited)
queue_length_limit.max = 0

# Maximum message size in bytes (0 = unlimited)
max_message_size = 134217728  # 128MB

# Message persistence
msg_store_pool_cleanup_interval = 30000

# ============================================
# Dead Letter Configuration
# ============================================

# Default dead letter exchange
default_dead_letter_exchange =

# Default dead letter routing key
default_dead_letter_routing_key = dead.letter

# ============================================
# Consumer Configuration
# ============================================

# Consumer timeout in milliseconds
# 0 = disabled, >0 = timeout in ms
consumer_timeout = 3600000  # 1 hour

# Consumer prefetch count (global default)
default_consumer_prefetch = 100

# ============================================
# Security & Authentication
# ============================================

# Disable guest user from non-localhost
loopback_users.guest = false

# Default user credentials (changed in production!)
default_user = admin
default_pass = admin

# User tags
default_user_tags.administrator = true
default_user_tags.management = true

# Permissions (configure for specific vhosts)
default_permissions.configure = .*
default_permissions.read = .*
default_permissions.write = .*

# TODO: Enable SSL (uncomment for production)
# listeners.ssl.default = 5671
# ssl_options.cacertfile = /etc/rabbitmq/certs/ca.pem
# ssl_options.certfile = /etc/rabbitmq/certs/server.pem
# ssl_options.keyfile = /etc/rabbitmq/certs/key.pem
# ssl_options.verify = verify_peer
# ssl_options.fail_if_no_peer_cert = true

# ============================================
# Connection Management
# ============================================

# Maximum number of channels per connection
channel_max = 2047

# Maximum frame size in bytes
frame_max = 131072  # 128KB

# Maximum number of connections
connection_max = 1000

# Heartbeat timeout in seconds (0 = disable)
heartbeat = 60

# TCP keepalive
tcp_listen_options.keepalive = true
tcp_listen_options.nodelay = true
tcp_listen_options.backlog = 128

# ============================================
# Logging Configuration
# ============================================

# Log level (debug, info, warning, error)
log.file.level = info

# Log file location
log.file = /var/log/rabbitmq/rabbitmq.log

# Log rotation
log.file.rotation.date = $D0
log.file.rotation.count = 7
log.file.rotation.size = 10485760  # 10MB

# Log console output
log.console = false
log.console.level = warning

# Exchange log level
log.exchange.level = info

# ============================================
# Management Plugin Configuration
# ============================================

# Management path prefix
management.path_prefix = /

# Management load definitions from file
management.load_definitions = /etc/rabbitmq/definitions.json

# CORS settings
management.cors.allow_origins = *
management.cors.allow_methods = GET,PUT,DELETE,POST,OPTIONS
management.cors.allow_credentials = true

# Stats collection interval
management.rates_mode = basic

# ============================================
# Prometheus Plugin Configuration
# ============================================

# Prometheus return per-object metrics
prometheus.return_per_object_metrics = true

# Prometheus path
prometheus.path = /metrics

# ============================================
# Shovel Plugin (for WAN replication)
# ============================================

# Enable shovel plugin
shovel.distriqueue-shovel.source = amqp://
shovel.distriqueue-shovel.destination = amqp://
shovel.distriqueue-shovel.queue = job.dead-letter
shovel.distriqueue-shovel.ack-mode = on-confirm
shovel.distriqueue-shovel.reconnect-delay = 5

# ============================================
# Federation Plugin
# ============================================

# Enable federation upstreams
federation.upstream.distriqueue-upstream.uri = amqp://admin:admin@rabbitmq2:5672
federation.upstream.distriqueue-upstream.ack-mode = on-confirm
federation.upstream.distriqueue-upstream.trust-user-id = false

# ============================================
# Advanced Configuration
# ============================================

# Enable background GC
background_gc_enabled = true

# Maximum number of Erlang processes
num_acceptors.tcp = 10

# Maximum number of file descriptors
total_memory_available_override_value = 2GB

# Collector interval
collect_statistics_interval = 5000
